/**
 * Custom JSON form editor widget for Contentful.
 * Displays a form generated by a JSON Schema. The form input will generate JSON.
 */

'use strict';

var cfExt = window.contentfulExtension || window.contentfulWidget;

cfExt.init(initContentfulJsonFormEditor);

function initContentfulJsonFormEditor (cfApi) {
  cfApi.window.startAutoResizer();

  var editorElem = createElement('div', {className: 'jfe-editor-root'});
  var editor = new JSONEditor(editorElem, {
    theme: 'contentful',
    schema: window.CONTENTFUL_FORM_EDITOR_SCHEMA,
    no_additional_properties: true,
    required_by_default: true,
    startval: cfApi.field.getValue(),
    disable_collapse: true,
    disable_properties: true,
    show_errors: 'always'
  });
  editor.on('change', inputChanged);

  function inputChanged () {
    cfApi.window.updateHeight();
    validateAndSave();
  }

  var validateAndSave = debounce(function () {
    var errors = editor.validate();

    if (errors.length === 0) {
      var currentJSON = editor.getValue();
      cfApi.field.setValue(currentJSON);
    }
  }, 150);
}

function createElement (elem, opts, parent) {
  var e = document.createElement(elem);
  var prop;

  for (prop in opts) {
    e[prop] = opts[prop];
  }
  parent = parent || document.body;
  parent.appendChild(e);
  return e;
}

// http://davidwalsh.name/javascript-debounce-function
function debounce (func, wait) {
  var timeout;
  return function () {
    var context = this, args = arguments;
    var later = function () {
      timeout = null;
      func.apply(context, args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
    if (!timeout) func.apply(context, args);
  };
}
